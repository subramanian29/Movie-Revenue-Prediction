<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Form</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .input-container {
            position: relative;
            margin-bottom: 1rem;
        }
        .input-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .input-container input[type="text"],
        .input-container input[type="date"] {
            width: 100%; /* Full width of container */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .suggestions-box {
            border: 1px solid #ccc;
            background: #fff;
            position: absolute;
            z-index: 1000;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 2px); /* Ensures dropdown width matches input */
            box-sizing: border-box;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        .suggestion-item {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: #f0f0f0;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            font-size: 18px;
        }
        .predicted-revenue {
            font-weight: bold;
        }
        .actual-revenue {
            color: darkgreen;
            font-weight: bold;
        }
    </style>
    <script>
        $(document).ready(function() {
            function setupAutocomplete(inputSelector, suggestionBoxSelector, url, isMultiField) {
                var $input = $(inputSelector);
                var $suggestionsBox = $(suggestionBoxSelector);
                var $container = $input.closest('.input-container');
                var selectedIndex = -1;

                function fetchSuggestions(query) {
                    $.ajax({
                        url: url,
                        data: { 'term': query },
                        success: function(data) {
                            console.log("Suggestions data:", data);  // Debugging line
                            $suggestionsBox.empty();
                            if (data.length > 0) {
                                data.forEach(function(item) {
                                    $suggestionsBox.append('<div class="suggestion-item">' + item + '</div>');
                                });
                                $suggestionsBox.show();
                            } else {
                                $suggestionsBox.hide();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error fetching suggestions:", error);  // Debugging line
                            $suggestionsBox.hide();
                        }
                    });
                }

                $input.on('input', function() {
                    var query = $(this).val().split(',').pop().trim();
                    if (query.length < 2) {
                        $suggestionsBox.hide();
                        return;  // Minimum length for search query
                    }
                    fetchSuggestions(query);
                });

                $input.on('keydown', function(e) {
                    var $items = $suggestionsBox.find('.suggestion-item');
                    if ($suggestionsBox.is(':visible')) {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (selectedIndex < $items.length - 1) {
                                selectedIndex++;
                                updateSelection();
                            }
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (selectedIndex > 0) {
                                selectedIndex--;
                                updateSelection();
                            }
                        } else if (e.key === 'Enter') {
                            e.preventDefault();
                            if (selectedIndex > -1) {
                                $items.eq(selectedIndex).click();
                            }
                        } else if (e.key === 'Escape') {
                            $suggestionsBox.hide();
                        }
                    }
                });

                function updateSelection() {
                    var $items = $suggestionsBox.find('.suggestion-item');
                    $items.removeClass('selected');
                    if (selectedIndex > -1) {
                        $items.eq(selectedIndex).addClass('selected');
                        $suggestionsBox.scrollTop($items.eq(selectedIndex).position().top - $suggestionsBox.height() + $items.eq(selectedIndex).outerHeight());
                    }
                }

                $suggestionsBox.on('click', '.suggestion-item', function() {
                    var value = $(this).text();
                    var currentValue = $input.val().split(',');
                    currentValue.pop(); // Remove the last part (the one being edited)
                    currentValue.push(value.trim()); // Add the selected suggestion
                    if (isMultiField) {
                        $input.val(currentValue.join(', ') + ', '); // Add comma after the value
                    } else {
                        $input.val(currentValue.join(', ').trim()); // Remove trailing comma if single field
                    }
                    $suggestionsBox.hide();

                    // Fetch and fill movie details
                    fetchMovieDetails(value.trim());
                });

                $(document).on('click', function(event) {
                    if (!$(event.target).closest($container).length) {
                        $suggestionsBox.hide();
                    }
                });
            }

            function fetchMovieDetails(title) {
                $.ajax({
                    url: '{% url "get_movie_details" %}',  // URL to your view
                    data: { 'title': title },
                    success: function(data) {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            $('#id_director').val(data.director);
                            $('#id_cast').val(data.cast.join(', '));
                            $('#id_crew').val(data.crew.join(', '));
                            $('#id_genres').val(data.genres.join(', '));
                            $('#id_keywords').val(data.keywords.join(', '));
                            $('#id_original_language').val(data.original_language);
                            $('#id_release_date').val(data.release_date);
                            $('#id_budget').val(data.budget);
                        }
                    },

                });
            }

            // Initialize autocomplete for each field
            setupAutocomplete('#id_title', '#title-suggestions', '{% url "search_title" %}', false);
            setupAutocomplete('#id_director', '#director-suggestions', '{% url "search_director" %}', false);
            setupAutocomplete('#id_cast', '#cast-suggestions', '{% url "search_cast" %}', true);
            setupAutocomplete('#id_crew', '#crew-suggestions', '{% url "search_crew" %}', true);
            setupAutocomplete('#id_genres', '#genres-suggestions', '{% url "search_genres" %}', true);
            setupAutocomplete('#id_keywords', '#keywords-suggestions', '{% url "search_keywords" %}', true);

            // Handle form submission
            $('form').on('submit', function(event) {
                event.preventDefault(); // Prevent default form submission
                
                // Collect form data
                var formData = {
                    title: $('#id_title').val(),
                    director: $('#id_director').val(),
                    cast: $('#id_cast').val(),
                    crew: $('#id_crew').val(),
                    genres: $('#id_genres').val(),
                    keywords: $('#id_keywords').val(),
                    original_language: $('#id_original_language option:selected').text(),
                    release_date: $('#id_release_date').val(),
                    budget: $('#id_budget').val()
                };

                // Process fields with multiple values
                function processField(value) {
                    if (value) {
                        return value.split(',').map(function(item) {
                            return item.trim();
                        }).filter(function(item) {
                            return item.length > 0;
                        });
                    }
                    return [];
                }

                var dictionary = {
                    title: formData.title,
                    director: formData.director,
                    cast: processField(formData.cast),
                    crew: processField(formData.crew),
                    genres: processField(formData.genres),
                    keywords: processField(formData.keywords),
                    original_language: formData.original_language,
                    release_date: formData.release_date,
                    budget: formData.budget
                };

                console.log("Form Data:", dictionary);
                
                // Send data to the server
                $.ajax({
                    type: 'POST',
                    url: '{% url "handle_movie_form" %}',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'data': JSON.stringify(dictionary)
                    },
                    success: function(response) {
                        $('#predicted_revenue').text('Predicted Revenue: ' + response.predicted_revenue);
                        $('#actual_revenue').text('Actual Revenue: ' + (response.actual_revenue || 'N/A'));
                    },
                    error: function() {
                        alert('Failed to submit the form.');
                    }
                });
            });
        });
    </script>
</head>
<body>
    <h1>Movie Form</h1>
    <form method="post" action="{% url 'handle_movie_form' %}">
        {% csrf_token %}

        <div class="input-container">
            <label for="id_title">Title:</label>
            {{ form.title }}
            <div id="title-suggestions" class="suggestions-box"></div>
        </div>

        <div class="input-container">
            <label for="id_director">Director:</label>
            {{ form.director }}
            <div id="director-suggestions" class="suggestions-box"></div>
        </div>

        <div class="input-container">
            <label for="id_cast">Cast:</label>
            {{ form.cast }}
            <div id="cast-suggestions" class="suggestions-box"></div>
        </div>

        <div class="input-container">
            <label for="id_crew">Crew:</label>
            {{ form.crew }}
            <div id="crew-suggestions" class="suggestions-box"></div>
        </div>

        <div class="input-container">
            <label for="id_genres">Genres:</label>
            {{ form.genres }}
            <div id="genres-suggestions" class="suggestions-box"></div>
        </div>

        <div class="input-container">
            <label for="id_keywords">Keywords:</label>
            {{ form.keywords }}
            <div id="keywords-suggestions" class="suggestions-box"></div>
        </div>

        <div class="input-container">
            <label for="id_original_language">Original Language:</label>
            {{ form.original_language }}
        </div>

        <div class="input-container">
            <label for="id_release_date">Release Date:</label>
            <input type="date" id="id_release_date" name="release_date">
        </div>

        <div class="input-container">
            <label for="id_budget">Budget:</label>
            {{ form.budget }}
        </div>

        <button type="submit">Submit</button>
    </form>

    <div id="predicted_revenue" class="result predicted-revenue">
        <!-- Predicted revenue will be displayed here -->
    </div>

    <div id="actual_revenue" class="result actual-revenue">
        <!-- Actual revenue will be displayed here -->
    </div>
</body>
</html>
